version: '3.0'
services:
  server:
    build: server
    ports:
      - "8080:8080"
    command: bash -c "
      /scripts/wait-for-it.sh db:3306 --timeout=60 --strict &&
      go run main.go"
    env_file:
      - ./server/.env
    volumes:
      - type: bind
        source: ./server
        target: /server
    depends_on:
      - db

  db:
    image: mysql:8.0.29
    platform: linux/amd64 # For M1 mac...
    environment:
      MYSQL_DATABASE: 'knowtfolio-db'
      MYSQL_ROOT_PASSWORD: 'password'
      MYSQL_ROOT_HOST: '%'
      TZ: 'Asia/Tokyo'
    ports:
      - "3306:3306"

  test:
    build: server
    command: bash -c "
      /scripts/wait-for-it.sh db:3306 --timeout=60 --strict &&
      go test ./models/... ./services/..."
    environment:
      ADMIN_PRIVATE_KEY: ac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
      CONTRACT_ADDRESS: will-be-set-in-the-program
      NETWORK_URI: http://hardhat:8545
      CHAIN_ID: 31337
    volumes:
      - type: bind
        source: ./server
        target: /server
    depends_on:
      - db
      - hardhat

  hardhat:
    build:
      context: .
      dockerfile: blockchain/Dockerfile
    ports:
      - "8545:8545"
    command: npm --prefix ./blockchain run node
    volumes:
      - type: bind
        source: ./blockchain
        target: /work/blockchain
      - type: bind
        source: ./server
        target: /work/server
